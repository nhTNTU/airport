/*
Deployment script for AirPortDB

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "AirPortDB"
:setvar DefaultFilePrefix "AirPortDB"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Altering [dbo].[AutoAddPeriodicalFlights]...';


GO
--Додавання періодичних рейсів

--Додавання записів про періодичний рейс за допомогою циклу while
ALTER TRIGGER [AutoAddPeriodicalFlights]
ON [dbo].[Flight]
AFTER INSERT
AS
	DECLARE @Count INT = 0;
	DECLARE @GlobalCount INT = (SELECT [fl_numOfFlights] FROM inserted);
	SET @Count = (SELECT [fl_numOfFlights] FROM inserted);
	DECLARE @DateTimeStartGlobal DATETIME = (SELECT [fl_dateTimeStart] FROM inserted);
	
	UPDATE [dbo].[Flight]
	SET [fl_status] = N'За роскладом'
	WHERE [fl_id] = (SELECT [fl_id] FROM inserted)
	
	DECLARE @id INT;
		DECLARE @idAirCompany INT;
		DECLARE @idPlane INT;
		DECLARE @idAirPort INT;
		DECLARE @FlightType NVARCHAR (20);
		DECLARE @DateTimeStart DATETIME;
		DECLARE @Duration DATETIME;
		DECLARE @Periodicity DATETIME;
		DECLARE @PriceEconom INT;
		DECLARE @PriceBusiness INT;
		DECLARE @PriceFirst INT;

		SET @idAirCompany = (SELECT [fl_airc_id_FK] FROM inserted);
		SET @idAirPort = (SELECT [fl_airP_id_FK] FROM inserted);
		SET @idPlane = (SELECT [fl_pln_id_FK] FROM inserted);
		SET @FlightType = (SELECT [fl_type] FROM inserted);
		SET @Periodicity = (SELECT [fl_periodicity] FROM inserted);
		SET @DateTimeStart = (SELECT [fl_dateTimeStart] FROM inserted)
		
		SET @Duration = (SELECT [fl_duration] FROM inserted);
		SET @PriceEconom = (SELECT [fl_priceEconom] FROM inserted);
		SET @PriceBusiness = (SELECT [fl_priceBusiness] FROM inserted);
		SET @PriceFirst = (SELECT [fl_priceFirst] FROM inserted);
	
	WHILE (@Count > 1)
	BEGIN
		SET @id = (SELECT TOP (1) [fl_id]  FROM [dbo].[Flight] ORDER BY [fl_id] DESC) + 1;
		SET @DateTimeStart = @DateTimeStart + @Periodicity;
		SET @Count = @Count - 1;
		
		INSERT INTO [dbo].[Flight] 
		([fl_airc_id_FK],[fl_pln_id_FK], [fl_airP_id_FK], [fl_type], [fl_dateTimeStart], [fl_duration],
			[fl_numOfFlights], [fl_periodicity], [fl_priceEconom], [fl_priceBusiness], [fl_priceFirst], [fl_status])
		VALUES
		(@idAirCompany, @idPlane, @idAirPort, @FlightType, @DateTimeStart, @Duration, @Count, @Periodicity, @PriceEconom, @PriceBusiness, @PriceFirst, N'За роскладом')
	END
GO
PRINT N'Update complete.';


GO
